---
title: "License Protocols"
description: "Deep dive into DRM license acquisition protocols - how keys are securely requested, delivered, and validated."
category: "protocols"
difficulty: "advanced"
estimatedReadTime: 35
order: 6
tags: ["license", "protocol", "key-exchange", "widevine", "fairplay", "playready"]
prerequisites: ["encryption", "overview"]
relatedArticles: ["widevine", "fairplay", "playready", "encryption"]
---

# License Protocols in DRM

License protocols are the communication layer between clients and license servers. They handle the secure exchange of content decryption keys while preventing interception and replay attacks.

## The License Acquisition Flow

All DRM systems follow a similar high-level flow:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Generic License Acquisition Flow                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌──────────┐         ┌──────────┐         ┌──────────────┐                │
│   │  Client  │         │  Proxy   │         │   License    │                │
│   │  (CDM)   │         │  Server  │         │    Server    │                │
│   └────┬─────┘         └────┬─────┘         └──────┬───────┘                │
│        │                    │                      │                         │
│        │  1. Parse PSSH     │                      │                         │
│        │  (get key IDs)     │                      │                         │
│        │                    │                      │                         │
│        │  2. Generate       │                      │                         │
│        │  License Request   │                      │                         │
│        │                    │                      │                         │
│        │─────────────────────────────────────────────────────────────────►  │
│        │  3. License Request (encrypted challenge)                          │
│        │                    │                      │                         │
│        │                    │                      │  4. Validate            │
│        │                    │                      │  Device                 │
│        │                    │                      │                         │
│        │                    │                      │  5. Check               │
│        │                    │                      │  Entitlements           │
│        │                    │                      │                         │
│        │◄────────────────────────────────────────────────────────────────   │
│        │  6. License Response (encrypted content keys)                      │
│        │                    │                      │                         │
│        │  7. Decrypt        │                      │                         │
│        │  Response          │                      │                         │
│        │                    │                      │                         │
│        │  8. Store Keys     │                      │                         │
│        │  in CDM            │                      │                         │
│        │                    │                      │                         │
│   └────┴─────┘         └────┴─────┘         └──────┴───────┘                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

<KeyConcept term="License Challenge">
The license request (challenge) is an encrypted blob generated by the CDM. It contains device identity, key IDs, and session information - all signed and encrypted to prevent tampering.
</KeyConcept>

## Widevine License Protocol

### Protocol Overview

Widevine uses a binary protocol based on Protocol Buffers (protobuf).

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Widevine License Protocol                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   License Request Structure:                                                 │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │ SignedMessage                                                       │    │
│   ├────────────────────────────────────────────────────────────────────┤    │
│   │ type: LICENSE_REQUEST                                              │    │
│   │ msg: LicenseRequest (protobuf)                                     │    │
│   │   ├── client_id: DeviceCertificate                                 │    │
│   │   ├── content_id: KeyID[]                                          │    │
│   │   ├── type: NEW | RENEWAL | RELEASE                                │    │
│   │   ├── request_time: timestamp                                      │    │
│   │   └── protocol_version: 21                                         │    │
│   │ signature: RSA-PSS signature                                       │    │
│   │ session_key: AES-encrypted session key                             │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│   License Response Structure:                                                │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │ SignedMessage                                                       │    │
│   ├────────────────────────────────────────────────────────────────────┤    │
│   │ type: LICENSE                                                       │    │
│   │ msg: License (protobuf)                                            │    │
│   │   ├── id: LicenseID                                                │    │
│   │   ├── policy: Policy                                               │    │
│   │   │     ├── can_play: bool                                         │    │
│   │   │     ├── can_persist: bool                                      │    │
│   │   │     ├── can_renew: bool                                        │    │
│   │   │     ├── license_duration_seconds                               │    │
│   │   │     └── playback_duration_seconds                              │    │
│   │   └── key: KeyContainer[]                                          │    │
│   │         ├── id: key_id                                             │    │
│   │         ├── iv: initialization_vector                              │    │
│   │         ├── key: encrypted_content_key                             │    │
│   │         └── type: CONTENT | SIGNING | OPERATOR                     │    │
│   │ signature: RSA-PSS signature                                       │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Key Derivation in Widevine

```python
# Conceptual key derivation (simplified)

# 1. Client generates ephemeral key pair
client_private, client_public = generate_rsa_keypair(2048)

# 2. License server encrypts content keys with client's public key
encrypted_content_key = rsa_oaep_encrypt(
    public_key=client_public,
    plaintext=content_key
)

# 3. Client decrypts using private key (inside CDM)
content_key = rsa_oaep_decrypt(
    private_key=client_private,
    ciphertext=encrypted_content_key
)
```

<RedTeamNote title="Protocol Attack Surface">
Attack vectors on the license protocol:
- **Request Forgery**: Crafting fake license requests with elevated privileges
- **Response Replay**: Reusing captured license responses for different content
- **MITM on Proxy**: If the proxy server doesn't validate properly
- **Session Key Extraction**: Obtaining session keys to decrypt responses
</RedTeamNote>

<BlueTeamNote title="Protocol Defenses">
Defense mechanisms in the protocol:
- **Device Binding**: Keys tied to specific device certificates
- **Nonce Freshness**: Random values prevent replay attacks
- **Timestamp Validation**: Requests must be within acceptable time window
- **Certificate Chain Validation**: Full PKI verification of device identity
</BlueTeamNote>

## FairPlay License Protocol (SPC/CKC)

### Server Playback Context (SPC)

FairPlay uses a unique challenge-response mechanism:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      FairPlay SPC/CKC Flow                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────┐                               ┌─────────────────┐         │
│   │   Client    │                               │  Key Server     │         │
│   │  (AVPlayer) │                               │  (Your Server)  │         │
│   └──────┬──────┘                               └────────┬────────┘         │
│          │                                               │                   │
│          │  1. Request Content Key Context               │                   │
│          │      (from playback URL)                      │                   │
│          │                                               │                   │
│          │  2. CDM creates SPC                           │                   │
│          │  ┌─────────────────────────────────┐          │                   │
│          │  │ SPC (Server Playback Context)   │          │                   │
│          │  │ ┌─────────────────────────────┐ │          │                   │
│          │  │ │ Version                     │ │          │                   │
│          │  │ │ Device Certificate          │ │          │                   │
│          │  │ │ Asset ID (Content ID)       │ │          │                   │
│          │  │ │ TLLV (encrypted payload)    │ │          │                   │
│          │  │ │   └── Session key           │ │          │                   │
│          │  │ │   └── Anti-replay data      │ │          │                   │
│          │  │ └─────────────────────────────┘ │          │                   │
│          │  └─────────────────────────────────┘          │                   │
│          │                                               │                   │
│          │  3. Forward SPC ──────────────────────────────►                   │
│          │                                               │                   │
│          │                                  4. Validate SPC                  │
│          │                                  5. Decrypt TLLV                  │
│          │                                  6. Create CKC                    │
│          │                                               │                   │
│          │  ┌─────────────────────────────────┐          │                   │
│          │  │ CKC (Content Key Context)       │          │                   │
│          │  │ ┌─────────────────────────────┐ │          │                   │
│          │  │ │ Content Key (encrypted)     │ │          │                   │
│          │  │ │ Key Duration (rental/buy)   │ │          │                   │
│          │  │ │ HDCP Requirements           │ │          │                   │
│          │  │ │ Persistence allowed?        │ │          │                   │
│          │  │ └─────────────────────────────┘ │◄─────────│                   │
│          │  └─────────────────────────────────┘          │                   │
│          │                                               │                   │
│          │  7. CDM processes CKC                         │                   │
│          │  8. Content key available                     │                   │
│          │                                               │                   │
│   └──────┴──────┘                               └────────┴────────┘         │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### FairPlay TLLV Structure

```
TLLV = Tag-Length-Length-Value (Apple's proprietary format)

┌────────────────────────────────────────────┐
│ TLLV Container                             │
├────────────────────────────────────────────┤
│ Tag (4 bytes)    │ Identifies data type    │
│ Total Length     │ Full TLLV size          │
│ Value Length     │ Payload size            │
│ Value (payload)  │ Actual data             │
└────────────────────────────────────────────┘

Common Tags:
- 0x47a6fc24: Content Key
- 0x6b68f542: Device Certificate
- 0x71b5595a: Session Key (encrypted)
- 0x89c90f5a: Anti-replay hash
```

<InfoBox title="Apple's Unique Approach">
FairPlay is the only major DRM that requires a Key Security Module (KSM) to be deployed on your own infrastructure. Apple provides the KSM as a software package that you integrate into your key server.
</InfoBox>

## PlayReady License Protocol

### SOAP-Based Protocol (Legacy)

```xml
<!-- PlayReady SOAP License Request -->
<soap:Envelope>
  <soap:Header>
    <PlayReadyHeader>
      <ClientVersion>4.0.0.0</ClientVersion>
      <DeviceModel>Edge Browser</DeviceModel>
    </PlayReadyHeader>
  </soap:Header>
  <soap:Body>
    <AcquireLicense>
      <challenge>
        <LA xmlns="http://schemas.microsoft.com/DRM/2007/03/protocols">
          <ContentHeader>
            <!-- WRMHEADER with KeyIDs -->
          </ContentHeader>
          <ClientInfo>
            <ClientVersion>4.0</ClientVersion>
            <SecurityLevel>2000</SecurityLevel>
          </ClientInfo>
          <LicenseNonce>randombase64data==</LicenseNonce>
        </LA>
      </challenge>
    </AcquireLicense>
  </soap:Body>
</soap:Envelope>
```

### REST-Based Protocol (Modern)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PlayReady REST License Protocol                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   License Request (HTTP POST):                                               │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │ Headers:                                                            │    │
│   │   Content-Type: application/octet-stream                           │    │
│   │   ms-playready-client-ver: 4.0                                     │    │
│   │                                                                     │    │
│   │ Body: Binary challenge blob                                        │    │
│   │ ┌────────────────────────────────────────────────────────────────┐ │    │
│   │ │ LA Record (License Acquisition)                                 │ │    │
│   │ │ ├── Record Type: 0x0001                                        │ │    │
│   │ │ ├── Record Length                                              │ │    │
│   │ │ ├── Client Certificate                                          │ │    │
│   │ │ ├── Content Header (KeyIDs)                                     │ │    │
│   │ │ └── Nonce (16 bytes)                                           │ │    │
│   │ └────────────────────────────────────────────────────────────────┘ │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│   License Response:                                                          │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │ XMR License (XML Rights Management)                                │    │
│   │ ├── License Version                                                │    │
│   │ ├── License ID (GUID)                                             │    │
│   │ ├── Rights:                                                        │    │
│   │ │     ├── Play (with output restrictions)                         │    │
│   │ │     ├── Copy (if allowed)                                       │    │
│   │ │     └── Transfer (domain transfers)                             │    │
│   │ ├── Keys:                                                          │    │
│   │ │     ├── Content Key (encrypted)                                 │    │
│   │ │     └── Key ID                                                  │    │
│   │ └── Restrictions:                                                  │    │
│   │       ├── Begin Date                                              │    │
│   │       ├── End Date                                                │    │
│   │       ├── Secure Stop required                                    │    │
│   │       └── Output Protection Level                                 │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Protocol Security Mechanisms

### Anti-Replay Protection

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Anti-Replay Mechanisms                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   1. NONCE (Number Used Once)                                               │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │ Request:  { nonce: "abc123...", timestamp: 1703001234 }            │    │
│   │ Response: { nonce: "abc123...", server_nonce: "xyz789..." }        │    │
│   │                                                                     │    │
│   │ Server stores used nonces for expiration window                    │    │
│   │ Reused nonce = Replay attack detected                              │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│   2. Timestamp Binding                                                       │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │ Request must be within ±5 minutes of server time                   │    │
│   │ Prevents storing requests for later use                            │    │
│   │                                                                     │    │
│   │ if abs(server_time - request_time) > 300:                          │    │
│   │     reject("Request expired")                                      │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│   3. Session Binding                                                         │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │ Each playback session has unique session ID                        │    │
│   │ Response keys are encrypted to session-specific key                │    │
│   │ Response cannot be used in different session                       │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Device Authentication

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Device Authentication Flow                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Device Certificate Chain:                                                  │
│                                                                              │
│   ┌────────────────┐                                                        │
│   │   Root CA      │  ← Hardcoded in license server                        │
│   │  (DRM vendor)  │                                                        │
│   └───────┬────────┘                                                        │
│           │ Signs                                                            │
│   ┌───────▼────────┐                                                        │
│   │ Intermediate   │  ← Model-level (OEM/manufacturer)                      │
│   │ Certificate    │                                                        │
│   └───────┬────────┘                                                        │
│           │ Signs                                                            │
│   ┌───────▼────────┐                                                        │
│   │    Device      │  ← Unique per device/browser                           │
│   │  Certificate   │                                                        │
│   └────────────────┘                                                        │
│                                                                              │
│   Validation:                                                                │
│   1. Verify signature chain to trusted root                                 │
│   2. Check certificate not revoked (CRL/OCSP)                              │
│   3. Verify device hasn't been blacklisted                                  │
│   4. Check security level meets content requirements                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

<WarningBox title="Revocation Lists">
DRM vendors maintain revocation lists (CRL) of compromised devices. When a CDM is cracked, all devices using that CDM version can be revoked, breaking playback until users update.
</WarningBox>

## License Policy Enforcement

### Policy Attributes

| Policy | Widevine | FairPlay | PlayReady |
|--------|----------|----------|-----------|
| License Duration | `license_duration_seconds` | `ckc-duration` | `BeginDate/EndDate` |
| Playback Duration | `playback_duration_seconds` | `ckc-playback-duration` | `PlayStart/PlayEnd` |
| Offline Allowed | `can_persist` | `persistence-allowed` | `License.Store` |
| HDCP Required | `hdcp_version` | `output-protection` | `MinimumCompressedDigitalVideoOPL` |
| Max Resolution | `resolution_constraints` | N/A | `MaxRes` |
| Secure Stop | N/A | N/A | `SecureStop` |

### Output Protection Levels

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Output Protection Requirements                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Resolution        HDCP Requirement        Typical Policy                   │
│   ──────────────────────────────────────────────────────────────────────    │
│   SD (480p)         None                    Basic protection                 │
│   HD (720p)         HDCP 1.4               Moderate protection              │
│   Full HD (1080p)   HDCP 2.0               Standard protection              │
│   4K UHD            HDCP 2.2               High protection                  │
│   4K HDR            HDCP 2.2 + HW TEE      Maximum protection               │
│                                                                              │
│   If output protection check fails:                                          │
│   - Downgrade resolution to allowed level                                   │
│   - Block playback entirely                                                 │
│   - Disable specific outputs (e.g., HDMI)                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

<RedTeamNote title="Policy Bypass Techniques">
Attackers target policy enforcement:
- **Modified CDMs**: Patched to ignore output restrictions
- **Virtual HDCP**: Fake HDCP handshakes to satisfy checks
- **Resolution spoofing**: Report lower resolution to get easier policy
- **Clock manipulation**: Change system time for expired licenses
</RedTeamNote>

<BlueTeamNote title="Secure Policy Enforcement">
Robust policy enforcement requires:
- **Hardware TEE**: Policy checks inside secure enclave
- **Attestation**: Verify device hasn't been tampered with
- **Secure time**: Use secure clock for expiration checks
- **Regular updates**: Push CDM updates to close bypasses
</BlueTeamNote>

## Multi-Key and Key Rotation

### Multi-Key Content

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Multi-Key Encryption                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Content with multiple quality levels:                                      │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Video Stream                                                         │   │
│   ├─────────────────────────────────────────────────────────────────────┤   │
│   │ 4K HDR  │ Key ID: abc-001 │ Policy: L1 only, HDCP 2.2              │   │
│   │ 1080p   │ Key ID: abc-002 │ Policy: L1/L2, HDCP 2.0                │   │
│   │ 720p    │ Key ID: abc-003 │ Policy: L1/L2/L3, HDCP 1.4             │   │
│   │ 480p    │ Key ID: abc-004 │ Policy: Any level, no HDCP             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│   License server provides keys based on device security level               │
│   L3 device only gets key abc-004                                           │
│   L1 device gets all keys                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Key Rotation

```
Time-Based Key Rotation:

Segment 1-100:    Key A (KID: key-001)
Segment 101-200:  Key B (KID: key-002)
Segment 201-300:  Key C (KID: key-003)
...

┌──────────────────────────────────────────────────────────────────────┐
│ Benefits:                                                             │
│ - Limits damage if key is extracted (only that segment range)        │
│ - Enables mid-stream policy changes                                  │
│ - Supports ad insertion with different key policies                  │
│                                                                       │
│ Challenges:                                                           │
│ - More license requests needed                                       │
│ - Client must handle seamless key transitions                        │
│ - Increased server load                                              │
└──────────────────────────────────────────────────────────────────────┘
```

## Protocol Vulnerabilities and Defenses

### Common Attack Patterns

| Attack | Target | Mitigation |
|--------|--------|------------|
| Request Tampering | License challenge | Signature verification |
| Response Replay | License response | Nonce binding, timestamps |
| Man-in-the-Middle | Network layer | TLS pinning, certificate validation |
| Downgrade Attack | Protocol version | Minimum version requirements |
| Token Theft | Auth tokens | Short TTL, IP binding |

### Defense in Depth

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Multi-Layer Protocol Security                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Layer 1: Transport Security                                                │
│   ├── TLS 1.3 required                                                      │
│   ├── Certificate pinning                                                   │
│   └── Perfect forward secrecy                                               │
│                                                                              │
│   Layer 2: Application Security                                              │
│   ├── Request signing (RSA/ECDSA)                                          │
│   ├── Response encryption                                                   │
│   └── Integrity verification                                                │
│                                                                              │
│   Layer 3: Business Logic                                                    │
│   ├── Entitlement verification                                              │
│   ├── Rate limiting                                                         │
│   └── Anomaly detection                                                     │
│                                                                              │
│   Layer 4: Device Trust                                                      │
│   ├── Device attestation                                                    │
│   ├── Certificate validation                                                │
│   └── Revocation checking                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Summary

| Aspect | Widevine | FairPlay | PlayReady |
|--------|----------|----------|-----------|
| Protocol Format | Protobuf (binary) | TLLV (binary) | SOAP/REST |
| Challenge Type | SignedMessage | SPC | LA Record |
| Response Type | License | CKC | XMR License |
| Auth Method | Device certificate | Device certificate | Device certificate |
| Key Encryption | RSA-OAEP | AES-CBC | ECC/AES |

## Next Steps

- **[Widevine Deep Dive](/knowledge-base/widevine)** - Protocol specifics for Widevine
- **[FairPlay Deep Dive](/knowledge-base/fairplay)** - SPC/CKC protocol details
- **[Protocol Lab](/labs/protocol-analysis)** - Hands-on protocol analysis
- **[Attack Scenarios](/labs/attacks)** - Common protocol attacks
